<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examination Portal - Secure Mode</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f0f2f5;
            color: #333;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .screen {
            display: none;
            height: 100vh;
        }

        .screen.active {
            display: block;
        }

        /* System Check Screen */
        .system-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .check-container {
            background: white;
            color: #333;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .check-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .check-header h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .check-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-success { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-error { background: #ef4444; color: white; }

        .start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Exam Interface */
        .exam-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .exam-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .exam-info h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .student-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .timer-section {
            text-align: center;
        }

        .timer {
            font-size: 2.2rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin-bottom: 5px;
        }

        .timer.warning {
            color: #fbbf24;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .exam-content {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        .question-panel {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .question-number {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .option-text {
            font-size: 1rem;
            color: #333;
        }

        /* Navigation Panel */
        .navigation-panel {
            width: 320px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-nav-btn {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .question-nav-btn:hover {
            border-color: #667eea;
        }

        .question-nav-btn.current {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .question-nav-btn.answered {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #10b981;
            color: white;
            width: 100%;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #333;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Camera Feed */
        .camera-feed {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 240px;
            height: 180px;
            background: black;
            border-radius: 12px;
            border: 3px solid #667eea;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        .eye-tracker {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.7rem;
            text-align: center;
        }

        /* Monitoring Panel */
        .monitoring-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .monitor-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: help;
        }

        .monitor-camera { background: #10b981; }
        .monitor-audio { background: #667eea; }
        .monitor-eye { background: #f59e0b; }
        .monitor-object { background: #8b5cf6; }

        /* Warning System */
        .warning-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            z-index: 2000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .warning-banner.show {
            transform: translateY(0);
        }

        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            display: none;
        }

        .alert-modal {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .alert-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .alert-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .alert-message {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        /* Fullscreen Warning */
        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ef4444;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            display: none;
        }

        .fullscreen-warning.show {
            display: flex;
        }

        .legend {
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .exam-content {
                flex-direction: column;
            }

            .navigation-panel {
                width: 100%;
                order: -1;
            }

            .camera-feed {
                width: 180px;
                height: 135px;
                top: 60px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Fullscreen Warning -->
    <div class="fullscreen-warning" id="fullscreenWarning">
        <i class="fas fa-exclamation-triangle" style="font-size: 5rem; margin-bottom: 30px;"></i>
        <h2 style="font-size: 2.5rem; margin-bottom: 20px;">Exam Must Be in Fullscreen</h2>
        <p style="font-size: 1.2rem; margin-bottom: 30px;">Please return to fullscreen mode to continue your examination</p>
        <button class="btn btn-primary" onclick="enterFullscreen()" style="padding: 20px 40px; font-size: 1.2rem;">
            <i class="fas fa-expand"></i>
            Enter Fullscreen
        </button>
    </div>

    <!-- System Check Screen -->
    <div id="systemCheckScreen" class="screen active">
        <div class="system-check">
            <div class="check-container">
                <div class="check-header">
                    <h2><i class="fas fa-shield-alt"></i> Security Verification</h2>
                    <p>Initializing secure examination environment...</p>
                </div>

                <div class="check-item">
                    <div>
                        <i class="fas fa-video"></i>
                        <strong>Camera Access</strong>
                        <div style="font-size: 0.9rem; color: #666;">Live proctoring</div>
                    </div>
                    <span id="cameraStatus" class="check-status status-warning">Checking...</span>
                </div>

                <div class="check-item">
                    <div>
                        <i class="fas fa-microphone"></i>
                        <strong>Microphone Access</strong>
                        <div style="font-size: 0.9rem; color: #666;">Audio monitoring</div>
                    </div>
                    <span id="micStatus" class="check-status status-warning">Checking...</span>
                </div>

                <div class="check-item">
                    <div>
                        <i class="fas fa-eye"></i>
                        <strong>Eye Tracking</strong>
                        <div style="font-size: 0.9rem; color: #666;">Gaze monitoring</div>
                    </div>
                    <span id="eyeStatus" class="check-status status-success">Ready</span>
                </div>

                <div class="check-item">
                    <div>
                        <i class="fas fa-search"></i>
                        <strong>Object Detection</strong>
                        <div style="font-size: 0.9rem; color: #666;">Unauthorized items</div>
                    </div>
                    <span id="objectStatus" class="check-status status-success">Active</span>
                </div>

                <div class="check-item">
                    <div>
                        <i class="fas fa-expand"></i>
                        <strong>Fullscreen Mode</strong>
                        <div style="font-size: 0.9rem; color: #666;">Secure environment</div>
                    </div>
                    <span id="fullscreenStatus" class="check-status status-success">Ready</span>
                </div>

                <button id="startExamBtn" class="start-btn disabled" onclick="startSecureExam()">
                    <i class="fas fa-play-circle"></i>
                    Start Secure Examination
                </button>
            </div>
        </div>
    </div>

    <!-- Exam Screen -->
    <div id="examScreen" class="screen">
        <div class="exam-container">
            <!-- Warning Banner -->
            <div class="warning-banner" id="warningBanner">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="warningMessage">Warning: Suspicious activity detected</span>
            </div>

            <!-- Exam Header -->
            <div class="exam-header">
                <div class="exam-info">
                    <h3 id="examTitle">Mathematics Examination</h3>
                    <div class="student-info">
                        Student: <span id="studentNameHeader">John Doe</span> | 
                        Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">20</span>
                    </div>
                </div>
                <div class="timer-section">
                    <div class="timer" id="examTimer">02:00:00</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Time Remaining</div>
                </div>
            </div>

            <!-- Exam Content -->
            <div class="exam-content">
                <!-- Question Panel -->
                <div class="question-panel">
                    <div class="question-number">
                        Question <span id="questionNumber">1</span>
                    </div>

                    <div class="question-text" id="questionText">
                        What is the derivative of f(x) = 3x² + 2x + 5?
                    </div>

                    <div class="options-container" id="optionsContainer">
                        <div class="option" onclick="selectOption(0)">
                            <input type="radio" name="answer" value="0" id="option0">
                            <div class="option-text">6x + 2</div>
                        </div>
                        <div class="option" onclick="selectOption(1)">
                            <input type="radio" name="answer" value="1" id="option1">
                            <div class="option-text">3x² + 2</div>
                        </div>
                        <div class="option" onclick="selectOption(2)">
                            <input type="radio" name="answer" value="2" id="option2">
                            <div class="option-text">6x + 5</div>
                        </div>
                        <div class="option" onclick="selectOption(3)">
                            <input type="radio" name="answer" value="3" id="option3">
                            <div class="option-text">3x + 2</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Panel -->
                <div class="navigation-panel">
                    <h4><i class="fas fa-th"></i> Question Navigation</h4>
                    <div class="question-grid" id="questionGrid">
                        <!-- Generated dynamically -->
                    </div>

                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #667eea;"></div>
                            <span>Current</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: white; border: 2px solid #e9ecef;"></div>
                            <span>Not Visited</span>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">
                            <i class="fas fa-chevron-left"></i>
                            Previous
                        </button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                            Next
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <button class="btn btn-success" id="submitBtn" onclick="submitExam()" style="margin-top: 20px; display: none;">
                        <i class="fas fa-check"></i>
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Feed -->
    <div class="camera-feed" id="cameraFeed" style="display: none;">
        <div class="camera-header">
            <i class="fas fa-video"></i> Live Monitoring Active
        </div>
        <video id="cameraVideo" autoplay muted></video>
        <div class="eye-tracker" id="eyeTracker">
            Eye Position: <span id="eyePosition">Center</span>
        </div>
    </div>

    <!-- Monitoring Panel -->
    <div class="monitoring-panel" id="monitoringPanel" style="display: none;">
        <div class="monitor-indicator monitor-camera" title="Camera Monitoring">
            <i class="fas fa-video"></i>
        </div>
        <div class="monitor-indicator monitor-audio" title="Audio Recording">
            <i class="fas fa-microphone"></i>
        </div>
        <div class="monitor-indicator monitor-eye" title="Eye Tracking">
            <i class="fas fa-eye"></i>
        </div>
        <div class="monitor-indicator monitor-object" title="Object Detection">
            <i class="fas fa-search"></i>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-modal">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-title" id="alertTitle">Security Violation</div>
            <div class="alert-message" id="alertMessage">Malpractice detected. This is your warning.</div>
            <button class="btn btn-primary" onclick="closeAlert()">I Understand</button>
        </div>
    </div>

    <script>
        // Application State
        let currentQuestionIndex = 0;
        let totalQuestions = 20;
        let examDuration = 120; // minutes
        let examStartTime = null;
        let answers = {};
        let warningCount = 0;
        let mediaStream = null;
        let isFullscreenActive = false;
        let examData = null;
        let eyeTrackingActive = false;
        let objectDetectionActive = false;
        let lastEyePosition = { x: 0, y: 0 };
        let eyeMovementThreshold = 100; // pixels

        // Sample exam questions
        const examQuestions = [
            {
                question: "What is the derivative of f(x) = 3x² + 2x + 5?",
                options: ["6x + 2", "3x² + 2", "6x + 5", "3x + 2"],
                correct: 0
            },
            {
                question: "Solve for x: 2x + 8 = 20",
                options: ["x = 6", "x = 8", "x = 4", "x = 12"],
                correct: 0
            },
            {
                question: "What is the value of sin(90°)?",
                options: ["0", "1", "-1", "∞"],
                correct: 1
            },
            {
                question: "Find the area of a circle with radius 7 units:",
                options: ["49π", "14π", "7π", "21π"],
                correct: 0
            },
            {
                question: "What is 15% of 200?",
                options: ["25", "30", "35", "40"],
                correct: 1
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadExamData();
            performSystemChecks();
            setupEventListeners();
            preventCheatingMethods();
        });

        function loadExamData() {
            const storedData = sessionStorage.getItem('examData');
            if (storedData) {
                examData = JSON.parse(storedData);
                document.getElementById('studentNameHeader').textContent = examData.student.name;
                
                // Set exam title based on selected exam
                const examTitles = {
                    mathematics: 'Mathematics Examination',
                    coding: 'Coding Level Test',
                    aptitude: 'Aptitude Test'
                };
                document.getElementById('examTitle').textContent = examTitles[examData.exam] || 'Examination';
            }
        }

        async function performSystemChecks() {
            try {
                // Request camera and microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: true 
                });

                document.getElementById('cameraStatus').className = 'check-status status-success';
                document.getElementById('cameraStatus').textContent = '✓ Active';
                
                document.getElementById('micStatus').className = 'check-status status-success';
                document.getElementById('micStatus').textContent = '✓ Recording';

                // Setup camera feed
                const video = document.getElementById('cameraVideo');
                video.srcObject = mediaStream;

                // Enable start button
                document.getElementById('startExamBtn').classList.remove('disabled');

                // Start eye tracking simulation
                startEyeTracking();
                
                // Start object detection simulation
                startObjectDetection();

            } catch (error) {
                document.getElementById('cameraStatus').className = 'check-status status-error';
                document.getElementById('cameraStatus').textContent = '✗ Denied';
                
                document.getElementById('micStatus').className = 'check-status status-error';
                document.getElementById('micStatus').textContent = '✗ Denied';
                
                showAlert('Permission Required', 'Camera and microphone access is mandatory for this examination.');
            }
        }

        async function startSecureExam() {
            try {
                // Enter fullscreen
                await document.documentElement.requestFullscreen();
                isFullscreenActive = true;

                // Switch screens
                document.getElementById('systemCheckScreen').classList.remove('active');
                document.getElementById('examScreen').classList.add('active');

                // Show monitoring components
                document.getElementById('cameraFeed').style.display = 'block';
                document.getElementById('monitoringPanel').style.display = 'flex';

                // Initialize exam
                examStartTime = new Date();
                totalQuestions = examQuestions.length;
                document.getElementById('totalQuestions').textContent = totalQuestions;
                
                generateQuestionNavigation();
                loadQuestion(0);
                startTimer();

            } catch (error) {
                showAlert('Fullscreen Required', 'This examination must be taken in fullscreen mode for security.');
            }
        }

        function setupEventListeners() {
            // Fullscreen change detection
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            // Visibility change detection (tab switching)
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Mouse movement for eye tracking
            document.addEventListener('mousemove', handleMouseMovement);
            
            // Prevent right-click
            document.addEventListener('contextmenu', e => e.preventDefault());
        }

        function preventCheatingMethods() {
            // Disable keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Prevent common cheating shortcuts
                const blockedKeys = ['F12', 'F5', 'F1', 'F11', 'Escape'];
                const blockedCombos = [
                    'ctrlKey+c', 'ctrlKey+v', 'ctrlKey+a', 'ctrlKey+s', 'ctrlKey+p',
                    'ctrlKey+f', 'ctrlKey+h', 'ctrlKey+j', 'ctrlKey+u', 'ctrlKey+r',
                    'ctrlKey+w', 'ctrlKey+t', 'ctrlKey+shift+i', 'ctrlKey+shift+j',
                    'altKey+Tab', 'ctrlKey+shift+Delete'
                ];

                if (blockedKeys.includes(e.key)) {
                    e.preventDefault();
                    handleSecurityViolation('Unauthorized key pressed: ' + e.key);
                }

                blockedCombos.forEach(combo => {
                    const [modifier, key] = combo.split('+');
                    if (e[modifier] && (e.key.toLowerCase() === key.toLowerCase() || e.key === key)) {
                        e.preventDefault();
                        handleSecurityViolation('Blocked keyboard combination used');
                    }
                });

                // Special handling for Escape key
                if (e.key === 'Escape') {
                    e.preventDefault();
                    handleSecurityViolation('Escape key pressed - attempting to exit exam');
                }
            });

            // Prevent page unload
            window.addEventListener('beforeunload', function(e) {
                if (document.getElementById('examScreen').classList.contains('active')) {
                    e.preventDefault();
                    e.returnValue = 'Leaving the exam will result in automatic submission.';
                    return e.returnValue;
                }
            });

            // Disable text selection
            document.onselectstart = function() { return false; };
            document.onmousedown = function() { return false; };
        }

        function startEyeTracking() {
            eyeTrackingActive = true;
            // Simulate eye tracking - in real implementation, this would use ML models
            setInterval(() => {
                if (eyeTrackingActive) {
                    // Simulate random eye movement detection
                    const positions = ['Center', 'Left', 'Right', 'Up', 'Down'];
                    const randomPosition = positions[Math.floor(Math.random() * positions.length)];
                    
                    document.getElementById('eyePosition').textContent = randomPosition;
                    
                    // Warn if looking away too much
                    if (randomPosition !== 'Center' && Math.random() > 0.7) {
                        handleSecurityViolation('Excessive eye movement detected - looking away from screen');
                    }
                }
            }, 2000);
        }

        function startObjectDetection() {
            objectDetectionActive = true;
            // Simulate object detection - in real implementation, this would analyze camera feed
            setInterval(() => {
                if (objectDetectionActive && Math.random() > 0.95) {
                    // Randomly simulate object detection
                    const objects = ['phone', 'book', 'paper', 'another person'];
                    const detectedObject = objects[Math.floor(Math.random() * objects.length)];
                    handleSecurityViolation(`Unauthorized object detected: ${detectedObject}`);
                }
            }, 5000);
        }

        function handleMouseMovement(e) {
            // Track large mouse movements as potential eye movements
            const currentX = e.clientX;
            const currentY = e.clientY;
            
            const deltaX = Math.abs(currentX - lastEyePosition.x);
            const deltaY = Math.abs(currentY - lastEyePosition.y);
            
            if (deltaX > eyeMovementThreshold || deltaY > eyeMovementThreshold) {
                if (Math.random() > 0.8) { // Randomly trigger for demo
                    handleSecurityViolation('Rapid eye/head movement detected');
                }
            }
            
            lastEyePosition = { x: currentX, y: currentY };
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement && document.getElementById('examScreen').classList.contains('active')) {
                isFullscreenActive = false;
                document.getElementById('fullscreenWarning').classList.add('show');
                handleSecurityViolation('Exited fullscreen mode');
            } else {
                isFullscreenActive = true;
                document.getElementById('fullscreenWarning').classList.remove('show');
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && document.getElementById('examScreen').classList.contains('active')) {
                handleSecurityViolation('Tab switching detected - left exam window');
            }
        }

        function handleSecurityViolation(reason) {
            warningCount++;
            
            console.log(`Security Violation ${warningCount}: ${reason}`);
            
            if (warningCount === 1) {
                // First warning
                showWarning(`WARNING: ${reason}. This is your only warning.`);
                showAlert('Security Warning', `Malpractice detected: ${reason}\n\nThis is your final warning. Any further violations will result in exam termination.`);
            } else {
                // Second violation - end exam
                showAlert('Exam Terminated', `Multiple security violations detected.\n\nReason: ${reason}\n\nYour exam has been automatically submitted.`);
                setTimeout(() => {
                    forceSubmitExam();
                }, 3000);
            }
        }

        function enterFullscreen() {
            document.documentElement.requestFullscreen();
        }

        function generateQuestionNavigation() {
            const questionGrid = document.getElementById('questionGrid');
            questionGrid.innerHTML = '';

            for (let i = 0; i < examQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-nav-btn';
                btn.textContent = i + 1;
                btn.onclick = () => loadQuestion(i);
                btn.id = `nav-btn-${i}`;
                questionGrid.appendChild(btn);
            }
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = examQuestions[index];

            document.getElementById('currentQuestionNum').textContent = index + 1;
            document.getElementById('questionNumber').textContent = index + 1;
            document.getElementById('questionText').textContent = question.question;

            // Update options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(i);
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" value="${i}" id="option${i}">
                    <div class="option-text">${option}</div>
                `;
                optionsContainer.appendChild(optionDiv);
            });

            // Restore previous answer
            if (answers[index] !== undefined) {
                selectOption(answers[index]);
            }

            updateNavigationButtons();
            updateQuestionNavigation();
        }

        function selectOption(optionIndex) {
            // Clear previous selections
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Select current option
            const selectedOption = document.querySelectorAll('.option')[optionIndex];
            selectedOption.classList.add('selected');
            selectedOption.querySelector('input').checked = true;

            // Save answer
            answers[currentQuestionIndex] = optionIndex;
            updateQuestionNavigation();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.classList.toggle('disabled', currentQuestionIndex === 0);
            
            if (currentQuestionIndex === examQuestions.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        function updateQuestionNavigation() {
            document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
                btn.classList.remove('current', 'answered');
                
                if (index === currentQuestionIndex) {
                    btn.classList.add('current');
                } else if (answers[index] !== undefined) {
                    btn.classList.add('answered');
                }
            });
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < examQuestions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            }
        }

        function startTimer() {
            const timerElement = document.getElementById('examTimer');
            
            const updateTimer = () => {
                const elapsed = Math.floor((new Date() - examStartTime) / 1000);
                const remaining = Math.max(0, (examDuration * 60) - elapsed);
                
                const hours = Math.floor(remaining / 3600);
                const minutes = Math.floor((remaining % 3600) / 60);
                const seconds = remaining % 60;
                
                timerElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Warning for last 10 minutes
                if (remaining <= 600) {
                    timerElement.classList.add('warning');
                }
                
                if (remaining <= 0) {
                    forceSubmitExam();
                    return;
                }
                
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }

        function submitExam() {
            const answeredCount = Object.keys(answers).length;
            const unansweredCount = examQuestions.length - answeredCount;
            
            let confirmMessage = `Are you sure you want to submit your exam?\n\n`;
            confirmMessage += `Answered: ${answeredCount}/${examQuestions.length} questions\n`;
            
            if (unansweredCount > 0) {
                confirmMessage += `Unanswered: ${unansweredCount} questions\n\n`;
                confirmMessage += `Unanswered questions will be marked as incorrect.`;
            }
            
            if (confirm(confirmMessage)) {
                forceSubmitExam();
            }
        }

        function forceSubmitExam() {
            // Stop all monitoring
            eyeTrackingActive = false;
            objectDetectionActive = false;
            
            // Calculate score
            let score = 0;
            examQuestions.forEach((question, index) => {
                if (answers[index] === question.correct) {
                    score++;
                }
            });

            const percentage = ((score / examQuestions.length) * 100).toFixed(1);

            // Stop media stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }

            // Exit fullscreen
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }

            // Show results
            let resultMessage = `Exam Submitted Successfully!\n\n`;
            resultMessage += `Student: ${examData ? examData.student.name : 'Student'}\n`;
            resultMessage += `Exam: ${examData ? examData.exam.toUpperCase() : 'Test'}\n\n`;
            resultMessage += `Score: ${score}/${examQuestions.length}\n`;
            resultMessage += `Percentage: ${percentage}%\n\n`;
            
            if (warningCount > 0) {
                resultMessage += `Security Violations: ${warningCount}\n`;
            }
            
            alert(resultMessage);
            
            // Clear session data
            sessionStorage.removeItem('examData');
            
            // Redirect to home
            window.location.href = 'index.html';
        }

        function showWarning(message) {
            const banner = document.getElementById('warningBanner');
            const messageElement = document.getElementById('warningMessage');
            
            messageElement.textContent = message;
            banner.classList.add('show');
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }

        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertOverlay').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('alertOverlay').style.display = 'none';
        }

        // Additional security measures
        
        // Disable print screen
        document.addEventListener('keyup', function(e) {
            if (e.keyCode == 44) {
                handleSecurityViolation('Print Screen attempted');
            }
        });

        // Monitor for developer tools
        let devtools = {
            open: false,
            orientation: null
        };
        
        setInterval(() => {
            if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
                if (!devtools.open) {
                    devtools.open = true;
                    handleSecurityViolation('Developer tools opened');
                }
            } else {
                devtools.open = false;
            }
        }, 500);

        // Disable drag and drop
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());

        // Disable image saving
        document.addEventListener('dragstart', e => e.preventDefault());

        // Monitor for multiple tabs/windows
        window.addEventListener('blur', function() {
            if (document.getElementById('examScreen').classList.contains('active')) {
                handleSecurityViolation('Window focus lost - possible tab switching');
            }
        });

        // Prevent copy-paste in input fields (if any)
        document.addEventListener('paste', function(e) {
            e.preventDefault();
            handleSecurityViolation('Paste operation attempted');
        });

        document.addEventListener('copy', function(e) {
            e.preventDefault();
            handleSecurityViolation('Copy operation attempted');
        });

        // Monitor for suspicious rapid clicking
        let clickCount = 0;
        let clickTimer = null;
        
        document.addEventListener('click', function() {
            clickCount++;
            
            if (clickTimer) {
                clearTimeout(clickTimer);
            }
            
            clickTimer = setTimeout(() => {
                if (clickCount > 20) {
                    handleSecurityViolation('Suspicious rapid clicking detected');
                }
                clickCount = 0;
            }, 3000);
        });

        // Prevent zoom
        document.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                handleSecurityViolation('Zoom attempt detected');
            }
        });

        // Mobile specific - prevent pinch zoom
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
                handleSecurityViolation('Multi-touch gesture detected');
            }
        });

        // Prevent text scaling on mobile
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        console.log('🔒 Secure Exam System Initialized');
        console.log('⚠️  All user actions are being monitored');
        console.log('📹 Camera and microphone active');
        console.log('👁️  Eye tracking enabled');
        console.log('🔍 Object detection active');
        
    </script>
</body>
</html>
        